# Backend Deep Dive

## Structure

The backend is a Node.js application structured using the MVC pattern.

### Key Entities (Models)

- **User**: Stores profile, Braintree customer ID, purchase history, and current cart.
- **Tag**: Represents a physical security tag. Links to a `Product` and a `Store`. Has an `isAvailable` flag.
- **Product**: Product meta-data (name, size, price, image).
- **Store**: Merchant information (merchantID for Braintree).
- **Purchase**: Record of a completed transaction.
- **OTP**: One-Time Passwords for authentication.

### Authentication & Security

- **Methods**: Supports Email/Password and Google OAuth.
- **Tokens**: Uses JWT for session management (Access and Refresh tokens).
- **Verification**:
  - Requests are validated using an Access Token.
  - **Double-Check**: The system performs a secondary validation by comparing the UUID in the token against the requested resource UUID (`validateAuthUUID.js`).
- **Validation**: Uses `zod` schemas (`server/schemas`) to validate request body and parameters.
- **NFC Security**: The system currently uses a default static password ("True password") for the HCE unlocking mechanism. _Note: When live, this would be replaced by unique, per-product password._

### Services

#### Email Service

Uses `nodemailer` to handle system emails:

1.  **Receipts**: Sent after a successful purchase via `sendReceipt.js` (called from `paymentController.js`).
2.  **OTP**: Sent during registration or password reset requests (`sendOTPEmail.js`).
3.  **Password Reset**: Sent when a user successfully resets their password.

#### Logging Service

Uses `winston` combined with `morgan` for robust application logging:

- **Library**: `winston` (Core), `winston-daily-rotate-file` (Rotation), `morgan` (HTTP).
- **Structure**: Logs are output as JSON for easy parsing.
- **Rotation**: Logs are rotated daily and retained for 14 days.
- **Streams**:
  - `logs/http-%DATE%.log`: All incoming HTTP requests (Status, Response Time, etc.).
  - `logs/error-%DATE%.log`: System errors.
  - `logs/info-%DATE%.log`: General information.

### Key Controllers

#### Payment Controller (`paymentController.js`)

This is the core business logic handler.

- **Payment Method Setup (`changePaymentMethod`)**:
  - Receives a `paymentMethodNonce` from the client (generated by Braintree SDK).
  - Vaults this method in Braintree and sets it as the **Default Payment Method** for the user.
- **Transaction (`createTransaction`)**:
  - Does **not** require a nonce. It uses the user's stored `braintreeCustomerId` and the default payment method in the Vault.
  - **Validation**: Checks if tags are `isAvailable: true`.
  - **Calculation**: Sums up the prices.
  - **Braintree Interaction**: Charges the vaulted instrument.
  - **Post-Payment**: Updates tag availability, records purchase, and triggers the **Receipt Email**.

#### Store Controller (`storesController.js`)

Handles the creation and management of inventory, as well as serving product data to the client.

- **Product Fetching (`getProduct`)**:
  - This is the endpoint hit by the app after scanning a tag.
  - Receives a `tagUuid` from the client.
  - Lookups: Validates the Tag existence -> Finds the associated Store -> Finds the associated Product.
  - Returns the full product details (Name, Size, Price, Image) to the client for display in the "Scan Result" or "Cart" screens.
- **Product Creation**: Done manually (e.g., via Postman/Curl) for POC purposes.
  - `addProductToStore`: Links a physical tag to a product SKU in a specific store.
  - **Tag Generation**: When a product is added to a store inventory, a new `TagModel` is created automatically, generating the unique UUID required for the physical tag.

### API Routes

- `/payment`: Handled by `paymentRoutes.js`.
- `/users`: Handled by `usersRoutes.js` (User profile, cart management, auth).
- `/stores`: Handled by `storesRoutes.js` (Store info, Inventory management).
- **Middleware**: `validateResource.js` intercepts requests to apply Zod validation.
